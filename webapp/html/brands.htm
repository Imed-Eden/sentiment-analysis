<title>Brands</title>
<link rel=stylesheet type=text/css href="../css/main.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script src="../js/app.js"></script>
<html lang="en">
    <body>
		<h3>Brands:</h3>
        <div class="brand_selector" align="center">
            <select value="brand" id="brands_filter">
                <option value="">Select product</option>
            </select>
            <br>
            <p></p>
            <br>
            <script>
                brands_list = ""
                $.ajax({
                    async: false,
                    type: 'GET',
                    url: "/get-brands",
                    success: function(data) {
                        brands_list = data
                    }
                });
                $(document).ready(function(){
                    function load_json_data(id) {
                        var html_code = '<option value="">Select product</option>'
                        brands_list.forEach(element => {
                            html_code += '<option id="'+element+'" value="'+element+'">'+element+'</option>'
                        })
                        $('#'+id).html(html_code);
                    }
                load_json_data('brands_filter')
                })
            </script>
        </div>
        
		<h3>Select a metric:</h3>
		<div class="btn-group2" style="text-align:center">
			<button id='btn2-1' value='price'>Price</button>
			<button id='btn2-2' value='mark'>Mark</button>
			<button id='btn2-3' value='likes'>Likes</button>
			<button id='btn2-4' value='positivity'>Positivity</button>
			<button id='btn2-5' value='popularity'>Popularity</button>
		</div>
		<br>
		<h3>Add another metric?:</h3>
		<div class="btn-group3" style="text-align:center">
			<button id='btn3-1' value='price'>Price</button>
			<button id='btn3-2' value='mark'>Mark</button>
			<button id='btn3-3' value='likes'>Likes</button>
			<button id='btn3-4' value='positivity'>Positivity</button>
			<button id='btn3-5' value='popularity'>Popularity</button>
			<button id='btn3-6' value='No'>No</button>
		</div>
		<br>
		<div class="btn-submit" style="text-align:center">
			<input type = "hidden" id='filter1' name="brand" value='%'>
			<input type = "hidden" id='filter2', name="metric1" value='%'>
			<input type = "hidden" id="filter3" name="metric2" value='%'>
			<button id="btn-submit" type="submit" onclick="showDiv(document.getElementById('brands_filter').value, document.getElementById('filter2').value, document.getElementById('filter3').value)">Submit</button>
			<script>
				function updateValues(brands_filter, filter2, filter3) {
					drawGraph(brands_filter, filter2, filter3)
				}
				function showDiv(brands_filter, filter2, filter3) {
					$('#myChart').remove();
					$('#graphResults').append('<canvas id="myChart"></canvas>');
                    updateValues(brands_filter, filter2, filter3)
					document.getElementById('graphResults').style.display = "block";
				}
			</script>
	</div>
	
	<div id="graphResults"  style="display:none;">
		<br><br><br>
		<h3>Results:</h3>
		<canvas id="myChart"></canvas>
		<script>
			async function drawGraph(brands_filter, metric1, metric2) {
				if (metric2 == '%' || metric2 == 'No') {
					var file_name = brands_filter + "_" + metric1 + ".json"
				} else {
					var file_name = brands_filter + '_' + metric1 + "_and_" + metric2 + ".json"
				}
				console.log(file_name)
				var graphTitle = ""
				var x_axis_title = ""
				var y_axis_title = ""						
				switch (metric1) {
					case 'likes':
						metric1 = 'number_likes';
						x_axis_title = "Number of likes"
						break;
					case 'positivity':
						metric1 = 'positive'
						x_axis_title = "Percentage of positive reviews"
						break;
					case 'price':
						x_axis_title = "Price"
						metric1 = 'price'
						break
					case 'mark':
						x_axis_title = "Mark"
						metric1 = 'mark'
						break
					case 'popularity':
						metric1 = 'wilson_score'
						x_axis_title = 'Popularity'
						break
					default:
						metric1 = ""
				}
				switch (metric2) {
					case 'likes':
						metric2 = 'number_likes';
						y_axis_title = "Number of likes"
						break;
					case 'positivity':
						metric2 = 'positive'
						y_axis_title = "Percentage of positive reviews"
						break;
					case 'price':
						y_axis_title = "Price"
						metric2 = 'price'
						break
					case 'mark':
						y_axis_title = "Mark"
						metric2 = 'mark'
						break
					case 'popularity':
						metric2 = 'wilson_score'
						x_axis_title = 'Popularity'
						break
					default:
						metric2 = ""
				}
				if (metric2 == "") {
					graphTitle = brands_filter + " - " + x_axis_title				
				} else {
					graphTitle = brands_filter + " - " + x_axis_title + " and " + y_axis_title
				}

				var products_data = ""
				$.ajax({
					 async: false,
					 type: 'GET',
					 url: file_name,
					 success: function(data) {
						  products_data = data
					 }
				});

				products_data = products_data.toString()
				products_data = products_data.replace(/'/g,'"');
				products_data = products_data.replace(/\\xc8/g,'È');
				products_data = products_data.replace(/\\xc9/g,'É');
				products_data = products_data.replace(/\\xd4/g,'Ô');				
				products_data = JSON.parse(products_data)

				function getRandomColor() {
					var letters = '0123456789ABCDEF';
					var color = '#';
					for (var i = 0; i < 6; i++) {
						color += letters[Math.floor(Math.random() * 16)];
					}
					return color;
				}

				if (metric2 == "") {
					var families = []
					var metricData = []
					for(const [key, value] of Object.entries(products_data)) {
                                                label = key.replace(/&#(\d{0,4});/g, function(fullStr, str) {return String.fromCharCode(str);}); //For special charaters
						metricData.push({"label": label, "data": [value[metric1]], "backgroundColor": getRandomColor()})
					}
					var ctx = document.getElementById("myChart");
					var config = {
						type: 'bar',
						data: {
							labels: [x_axis_title],
							datasets: metricData
						},
						responsive: true
					}
					var barChart = new Chart(ctx, config);
				}
				else {
					var dot_labels = [];
					var datapoints = []
					var data_values = []
					for(var key in products_data) {
						data_value = []
                                                label = key.replace(/&#(\d{0,4});/g, function(fullStr, str) {return String.fromCharCode(str);}); //For special charaters
						data_value['label'] = label;
						data_value['data'] = [{'x': products_data[key][metric1], 'y': products_data[key][metric2]}];
						data_value['fill'] = false;
						data_value['showLine'] = false;
						data_value['pointRadius'] = 5;
						data_value['backgroundColor'] = getRandomColor()
						data_values.push(data_value)
					}
					var ctx = document.getElementById("myChart");
					var scatterChart = new Chart(ctx, {
						type: 'scatter',
						data: {
							datasets: data_values
						},
						options: {
							scales: {
								xAxes: [{
									type: 'linear',
									position: 'bottom',
									scaleLabel: {
										display: true,
										labelString: x_axis_title,
										fontSize: 16
									}
								}],
								yAxes: [{
									display: true,
									scaleLabel: {
										display: true,
										labelString: y_axis_title,
										fontSize: 16
									}
								}]
							},
							title: {
								display: true,
								text: graphTitle,
								fontSize: 24
							   },
							responsive: true,
							tooltips: {
								mode: 'point',
								titleFontSize: 12,
								titleFontStyle: 'bold',
								callbacks: {
									label: function(tooltipItem, data) {
										var label = data.datasets[tooltipItem.datasetIndex]['label']
										return label + ': ' + x_axis_title + ': ' + tooltipItem.xLabel + ', ' + y_axis_title + ': ' + tooltipItem.yLabel;
									}
								}
							}
						}
					});
				}
			}
		</script>
	</div>
	<div id ="menu">
		<button onclick="location.href='index.htm';">Back to menu</button>
	</div>
</body>
</html>
