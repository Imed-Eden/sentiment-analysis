<!DOCTYPE html>
<title>Products</title>
<link rel=stylesheet type=text/css href="../css/main.css">
<link rel=stylesheet type=text/css href="https://unpkg.com/tabulator-tables@4.6.3/dist/css/tabulator.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script src="../js/app.js"></script>
<script src="https://unpkg.com/tabulator-tables@4.6.3/dist/js/tabulator.min.js" type="text/javascript"></script>


<html lang="en">
    <body>
        <h3>Select the product:</h3>
        <!-- <div class="product_selector" style="width:600px;"> -->
        <div class="product_selector" align="center">
            <select name="products" id="products">
                <option value="">Select product</option>
            </select>
            <br>
            <p></p>
            <br>
        </div>
        <div id="products_table"></div>
        <div id ="menu">
			<button onclick="location.href='index.htm';">Back to menu</button>
		</div>
    </body>
</html>
      
<script>
    var products_list = ""
    $.ajax({
        async: false,
        type: 'GET',
        url: "/get-brands",
        success: function(data) {
            products_list = data
        }
    });
    console.log(products_list)
    $(document).ready(function(){
        function load_json_data(id) {
            var html_code = '<option value="">Select product</option>'
            products_list["value"].forEach(element => {
                html_code += '<option id="'+element["product_name"]+'/'+element["brand"]+'" value="'+element["family"]+'/'+element["type"]+'/'+element["gender"]+'">'+element["product_name"]+'</option>'
            })
            $('#'+id).html(html_code);
        }
        load_json_data('products')
        $(document).on('change', '#products', function() {
            var family = $(this).val().split('/')[0].replace('&', '%26')
            var type = $(this).val().split('/')[1].replace('&', '%26')
            var gender = $(this).val().split('/')[2].replace('&', '%26')
            var queryString = "*&$count=true&$top=1000&$filter=family eq '"+family+"' and gender eq '"+gender+"' and type eq '"+type+"'"
            console.log(queryString)
            products_data = ""
            $.ajax({
                async: false,
                type: 'GET',
                url: "/search/"+queryString,
                success: function(data) {
                    products_data = data
                }
            });
            var tabledata = products_data["value"]
            var table = new Tabulator("#products_table", {
                data:tabledata,
                columns:[
                    {title:"Position", formatter:"rownum"},
                    {title:"Product Name", field:"product_name"},
                    {title:"Brand", field:"brand"},
                    {title:"Price", field:"price"},
                    {title:"Mark", field:"mark", formatter:"star", formatterParams:{stars:5}},
                    {title:"Number of Likes", field:"number_likes"},
                    {title:"Number of Reviews", field:"number_reviews"},
                    {title:"Positive Reviews", field:"positive", formatter:function(cell, formatterParams, onRendered){return cell.getValue()+" %";}},
                    {title:"Neutral Reviews", field:"neutral", formatter:function(cell, formatterParams, onRendered){return cell.getValue()+" %";}},
                    {title:"Negative Reviews", field:"negative", formatter:function(cell, formatterParams, onRendered){return Math.abs(cell.getValue())+" %";}},
                    {title:"Reviews Popularity score", field:"wilson_score", formatter:function(cell, formatterParams, onRendered){return Math.round(cell.getValue()*100)+" / 100";}},
                ],
                rowFormatter:function(row){
                    var data = row.getData();
                    if(data.product_name == document.getElementById("products").options[document.getElementById("products").selectedIndex].id.split('/')[0]){
                        row.getElement().style.backgroundColor = "#66FFB3";
                    } else if (data.brand == document.getElementById("products").options[document.getElementById("products").selectedIndex].id.split('/')[1]) {
                        row.getElement().style.backgroundColor = "#B3E6FF";
                    }
                },
            });

        })
    })
</script>

